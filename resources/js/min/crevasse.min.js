(function(){var $,Crevasse,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};$=jQuery,$.fn.extend({crevasse:function(options){return $(this).each(function(){return new Crevasse($(this),options)})}}),Crevasse=function(){function Crevasse($el,options){if(null==options&&(options={}),this._onEditorChange=__bind(this._onEditorChange,this),this.options=$.extend({},this.settings,options),!$el.is("textarea"))throw"You must initialize on a textarea";if(!this.options.previewer)throw"You must provide a previewer element via options";"string"==typeof this.options.previewer&&(this.options.previewer=$(this.options.previewer)),this.editor=new Crevasse.Editor($el,this.options),this.previewer=new Crevasse.Previewer(this.options.previewer,this.options),this.editor.bind("change",this._onEditorChange),""!==this.editor.getText()&&this._updatePreview()}return Crevasse.prototype.settings={previewer:null,editorStyle:"default",usePreviewerReset:!0,previewerStyle:"github",convertTabsToSpaces:2},Crevasse.prototype.editor=null,Crevasse.prototype.previewer=null,Crevasse.prototype._onEditorChange=function(){return this._updatePreview()},Crevasse.prototype._updatePreview=function(){return this.previewer.render(this.editor.getText(),this.editor.getCaretPosition())},Crevasse}(),Crevasse.Events=function(){function Events(){}return Events.prototype.bindings={},Events.prototype.bind=function(name,handler){return null==this.bindings[name]&&(this.bindings[name]=[]),Crevasse.utils.includes(this.bindings[name],handler)?void 0:this.bindings[name].push(handler)},Events.prototype.unbind=function(name,handler){return null==handler?delete this.bindings[name]:(null!=this.bindings[name]&&Crevasse.utils.remove(this.bindings[name],handler),this.bindings[name].length<1?delete this.bindings[name]:void 0)},Events.prototype.trigger=function(name){var handler,_i,_len,_ref,_results;if(null!=this.bindings[name]){for(_ref=this.bindings[name],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)handler=_ref[_i],_results.push(handler());return _results}},Events}(),Crevasse.Editor=function(_super){function Editor($el,options){return this.$el=$el,this.options=options,this._parseTabsToSpaces=__bind(this._parseTabsToSpaces,this),this._replaceTabs=__bind(this._replaceTabs,this),this._onPaste=__bind(this._onPaste,this),this._onInput=__bind(this._onInput,this),this.$el.addClass("crevasse_editor"),this.$el.addClass(this._theme()),this.options.convertTabsToSpaces&&this._replaceTabs(this.options.convertTabsToSpaces),this.$el.bind(""+this._inputEventName()+" change",this._onInput),this.$el.bind("paste",this._onPaste),this}return __extends(Editor,_super),Editor.prototype.options=null,Editor.prototype.$el=null,Editor.prototype.text=null,Editor.prototype.spaces=null,Editor.prototype.getText=function(){return this.$el.val()},Editor.prototype.getCaretPosition=function(){return this.$el.caret()},Editor.prototype._theme=function(){switch(this.options.editorStyle){case"default":return"default_theme";default:return this.options.editorStyle}},Editor.prototype._onInput=function(){return this.text!==this.getText()?(this.text=this.getText(),this.trigger("change")):void 0},Editor.prototype._onPaste=function(){var _this=this;return setTimeout(function(){return _this.trigger("change")},20)},Editor.prototype._replaceTabs=function(numSpaces){for(this.spaces="";numSpaces--;)this.spaces+=" ";return this.$el.bind("keydown",this._parseTabsToSpaces)},Editor.prototype._parseTabsToSpaces=function(event){return 9===event.keyCode?(event.preventDefault(),this.$el.insertAtCaret(this.spaces)):void 0},Editor.prototype._inputEventName=function(){return this._supportsInputEvent()?"input":"keydown"},Editor.prototype._supportsInputEvent=function(){var el,eventName,isSupported;return el=document.createElement("textarea"),eventName="oninput",isSupported=__indexOf.call(el,eventName)>=0,isSupported||(el.setAttribute(eventName,"return;"),isSupported="function"==typeof el[eventName]),el=null,isSupported},Editor}(Crevasse.Events),Crevasse.Previewer=function(){function Previewer($el,options){var _this=this;return this.$el=$el,this.options=options,this._onResize=__bind(this._onResize,this),this.options.usePreviewerReset&&this.$el.addClass("crevasse_reset"),this._getDimensions(),this.$previewer=$("<div class='crevasse_previewer'>"),this.$previewer.addClass(this._theme()),this.$el.append(this.$previewer),this.$offsetDeterminer=this.$previewer.clone(),this.$offsetDeterminer.css({width:this.width,height:"auto",position:"absolute",top:0,left:-1e4}),this.$el.append(this.$offsetDeterminer),this.$el.bind("crevasse.resize",this._onResize),marked.setOptions({gfm:!0,pedantic:!1,sanitize:!0,highlight:function(code,lang){var processed_code;return lang=null!=_this.LANG_MAP[lang]?_this.LANG_MAP[lang]:lang,processed_code=null,"undefined"!=typeof Rainbow&&null!==Rainbow&&Rainbow.color(code,lang,function(highlighted_code){return processed_code=highlighted_code}),processed_code||code}}),this}return Previewer.prototype.LANG_MAP={js:"javascript",json:"javascript"},Previewer.prototype.options=null,Previewer.prototype.$el=null,Previewer.prototype.$previewer=null,Previewer.prototype.$offsetDeterminer=null,Previewer.prototype.width=null,Previewer.prototype.height=null,Previewer.prototype.render=function(text,caretPosition){var offset;if(null==caretPosition&&(caretPosition=null),this.$previewer.html(this._parse(text)),"undefined"!=typeof Rainbow&&null!==Rainbow&&this.$previewer.find("code").addClass("rainbow"),null!=caretPosition){offset=this._determineOffset(text.substr(0,caretPosition)),0>offset&&(offset=0);try{return this.$el.scrollTo(offset,0)}catch(error){}}},Previewer.prototype._theme=function(){switch(this.options.previewerStyle){case"github":return"github_theme";default:return this.options.previewerStyle}},Previewer.prototype._determineOffset=function(text){var textHeight;return this.$offsetDeterminer.html(this._parse(text)),textHeight=this.$offsetDeterminer.outerHeight(),textHeight-this.height/2},Previewer.prototype._onResize=function(){return this._getDimensions(),this._updateOffsetDeterminerDimensions()},Previewer.prototype._getDimensions=function(){return this.width=this.$el.width(),this.height=this.$el.height()},Previewer.prototype._updateOffsetDeterminerDimensions=function(){return this.$offsetDeterminer.width(this.width)},Previewer.prototype._parse=function(text){return marked(text)},Previewer}(),Crevasse.utils={},Crevasse.utils.includes=function(array,value){var val,_i,_len;for(_i=0,_len=array.length;_len>_i;_i++)if(val=array[_i],val===value)return!0;return!1},Crevasse.utils.remove=function(array,value){var i,val,_i,_len;for(i=_i=0,_len=array.length;_len>_i;i=++_i)val=array[i],val===value&&array.splice(i,1)}}).call(this);