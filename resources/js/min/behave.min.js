(function(undefined){"use strict";var BehaveHooks=BehaveHooks||function(){var hooks={};return{add:function(hookName,fn){if("object"==typeof hookName){var i;for(i=0;i<hookName.length;i++){var theHook=hookName[i];hooks[theHook]||(hooks[theHook]=[]),hooks[theHook].push(fn)}}else hooks[hookName]||(hooks[hookName]=[]),hooks[hookName].push(fn)},get:function(hookName){return hooks[hookName]?hooks[hookName]:void 0}}}(),Behave=Behave||function(userOpts){"function"!=typeof String.prototype.repeat&&(String.prototype.repeat=function(times){if(1>times)return"";if(times%2)return this.repeat(times-1)+this;var half=this.repeat(times/2);return half+half}),"function"!=typeof Array.prototype.filter&&(Array.prototype.filter=function(func){if(null===this)throw new TypeError;var t=Object(this),len=t.length>>>0;if("function"!=typeof func)throw new TypeError;for(var res=[],thisp=arguments[1],i=0;len>i;i++)if(i in t){var val=t[i];func.call(thisp,val,i,t)&&res.push(val)}return res});var tab,newLine,defaults={textarea:null,replaceTab:!0,softTabs:!0,tabSize:4,autoOpen:!0,overwrite:!0,autoStrip:!0,autoIndent:!0,fence:!1},charSettings={keyMap:[{open:'"',close:'"',canBreak:!1},{open:"'",close:"'",canBreak:!1},{open:"(",close:")",canBreak:!1},{open:"[",close:"]",canBreak:!0},{open:"{",close:"}",canBreak:!0}]},utils={_callHook:function(hookName,passData){var hooks=BehaveHooks.get(hookName);if(passData="boolean"==typeof passData&&passData===!1?!1:!0,hooks)if(passData){var i,theEditor=defaults.textarea,textVal=theEditor.value,caretPos=utils.cursor.get();for(i=0;i<hooks.length;i++)hooks[i].call(undefined,{editor:{element:theEditor,text:textVal,levelsDeep:utils.levelsDeep()},caret:{pos:caretPos},lines:{current:utils.cursor.getLine(textVal,caretPos),total:utils.editor.getLines(textVal)}})}else for(i=0;i<hooks.length;i++)hooks[i].call(undefined)},defineNewLine:function(){var ta=document.createElement("textarea");ta.value="\n",newLine=2==ta.value.length?"\r\n":"\n"},defineTabSize:function(tabSize){return"undefined"!=typeof defaults.textarea.style.OTabSize?(defaults.textarea.style.OTabSize=tabSize,void 0):"undefined"!=typeof defaults.textarea.style.MozTabSize?(defaults.textarea.style.MozTabSize=tabSize,void 0):"undefined"!=typeof defaults.textarea.style.tabSize?(defaults.textarea.style.tabSize=tabSize,void 0):void 0},cursor:{getLine:function(textVal,pos){return textVal.substring(0,pos).split("\n").length},get:function(){if("number"==typeof document.createElement("textarea").selectionStart)return defaults.textarea.selectionStart;if(document.selection){var caretPos=0,range=defaults.textarea.createTextRange(),rangeDupe=document.selection.createRange().duplicate(),rangeDupeBookmark=rangeDupe.getBookmark();for(range.moveToBookmark(rangeDupeBookmark);0!==range.moveStart("character",-1);)caretPos++;return caretPos}},set:function(start,end){if(end||(end=start),defaults.textarea.setSelectionRange)defaults.textarea.focus(),defaults.textarea.setSelectionRange(start,end);else if(defaults.textarea.createTextRange){var range=defaults.textarea.createTextRange();range.collapse(!0),range.moveEnd("character",end),range.moveStart("character",start),range.select()}},selection:function(){var normalizedValue,range,textInputRange,len,endRange,textAreaElement=defaults.textarea,start=0,end=0;return"number"==typeof textAreaElement.selectionStart&&"number"==typeof textAreaElement.selectionEnd?(start=textAreaElement.selectionStart,end=textAreaElement.selectionEnd):(range=document.selection.createRange(),range&&range.parentElement()==textAreaElement&&(normalizedValue=utils.editor.get(),len=normalizedValue.length,textInputRange=textAreaElement.createTextRange(),textInputRange.moveToBookmark(range.getBookmark()),endRange=textAreaElement.createTextRange(),endRange.collapse(!1),textInputRange.compareEndPoints("StartToEnd",endRange)>-1?start=end=len:(start=-textInputRange.moveStart("character",-len),start+=normalizedValue.slice(0,start).split(newLine).length-1,textInputRange.compareEndPoints("EndToEnd",endRange)>-1?end=len:(end=-textInputRange.moveEnd("character",-len),end+=normalizedValue.slice(0,end).split(newLine).length-1)))),start==end?!1:{start:start,end:end}}},editor:{getLines:function(textVal){return textVal.split("\n").length},get:function(){return defaults.textarea.value.replace(/\r/g,"")},set:function(data){defaults.textarea.value=data}},fenceRange:function(){if("string"==typeof defaults.fence){for(var data=utils.editor.get(),pos=utils.cursor.get(),hacked=0,matchedFence=data.indexOf(defaults.fence),matchCase=0;matchedFence>=0&&(matchCase++,!(matchedFence+hacked>pos));)hacked+=matchedFence+defaults.fence.length,data=data.substring(matchedFence+defaults.fence.length),matchedFence=data.indexOf(defaults.fence);return pos>hacked&&matchedFence+hacked>pos&&0===matchCase%2?!0:!1}return!0},isEven:function(_this,i){return i%2},levelsDeep:function(){var i,j,pos=utils.cursor.get(),val=utils.editor.get(),left=val.substring(0,pos),levels=0;for(i=0;i<left.length;i++)for(j=0;j<charSettings.keyMap.length;j++)charSettings.keyMap[j].canBreak&&(charSettings.keyMap[j].open==left.charAt(i)&&levels++,charSettings.keyMap[j].close==left.charAt(i)&&levels--);var toDecrement=0,quoteMap=["'",'"'];for(i=0;i<charSettings.keyMap.length;i++)if(charSettings.keyMap[i].canBreak)for(j in quoteMap)toDecrement+=left.split(quoteMap[j]).filter(utils.isEven).join("").split(charSettings.keyMap[i].open).length-1;var finalLevels=levels-toDecrement;return finalLevels>=0?finalLevels:0},deepExtend:function(destination,source){for(var property in source)source[property]&&source[property].constructor&&source[property].constructor===Object?(destination[property]=destination[property]||{},utils.deepExtend(destination[property],source[property])):destination[property]=source[property];return destination},addEvent:function(element,eventName,func){element.addEventListener?element.addEventListener(eventName,func,!1):element.attachEvent&&element.attachEvent("on"+eventName,func)},removeEvent:function(element,eventName,func){element.addEventListener?element.removeEventListener(eventName,func,!1):element.attachEvent&&element.detachEvent("on"+eventName,func)},preventDefaultEvent:function(e){e.preventDefault?e.preventDefault():e.returnValue=!1}},intercept={tabKey:function(e){if(utils.fenceRange()){if(9==e.keyCode){utils.preventDefaultEvent(e);var toReturn=!0;utils._callHook("tab:before");var selection=utils.cursor.selection(),pos=utils.cursor.get(),val=utils.editor.get();if(selection){for(var tempStart=selection.start;tempStart--;)if("\n"==val.charAt(tempStart)){selection.start=tempStart+1;break}var i,toIndent=val.substring(selection.start,selection.end),lines=toIndent.split("\n");if(e.shiftKey){for(i=0;i<lines.length;i++)lines[i].substring(0,tab.length)==tab&&(lines[i]=lines[i].substring(tab.length));toIndent=lines.join("\n"),utils.editor.set(val.substring(0,selection.start)+toIndent+val.substring(selection.end)),utils.cursor.set(selection.start,selection.start+toIndent.length)}else{for(i in lines)lines[i]=tab+lines[i];toIndent=lines.join("\n"),utils.editor.set(val.substring(0,selection.start)+toIndent+val.substring(selection.end)),utils.cursor.set(selection.start,selection.start+toIndent.length)}}else{var left=val.substring(0,pos),right=val.substring(pos),edited=left+tab+right;e.shiftKey?val.substring(pos-tab.length,pos)==tab&&(edited=val.substring(0,pos-tab.length)+right,utils.editor.set(edited),utils.cursor.set(pos-tab.length)):(utils.editor.set(edited),utils.cursor.set(pos+tab.length),toReturn=!1)}utils._callHook("tab:after")}return toReturn}},enterKey:function(e){if(utils.fenceRange()&&13==e.keyCode){utils.preventDefaultEvent(e),utils._callHook("enter:before");var finalCursorPos,i,pos=utils.cursor.get(),val=utils.editor.get(),left=val.substring(0,pos),right=val.substring(pos),leftChar=left.charAt(left.length-1),rightChar=right.charAt(0),numTabs=utils.levelsDeep(),ourIndent="",closingBreak="";if(numTabs){for(;numTabs--;)ourIndent+=tab;for(ourIndent=ourIndent,finalCursorPos=ourIndent.length+1,i=0;i<charSettings.keyMap.length;i++)charSettings.keyMap[i].open==leftChar&&charSettings.keyMap[i].close==rightChar&&(closingBreak=newLine)}else finalCursorPos=1;var edited=left+newLine+ourIndent+closingBreak+ourIndent.substring(0,ourIndent.length-tab.length)+right;utils.editor.set(edited),utils.cursor.set(pos+finalCursorPos),utils._callHook("enter:after")}},deleteKey:function(e){if(utils.fenceRange()&&8==e.keyCode){utils.preventDefaultEvent(e),utils._callHook("delete:before");var i,pos=utils.cursor.get(),val=utils.editor.get(),left=val.substring(0,pos),right=val.substring(pos),leftChar=left.charAt(left.length-1),rightChar=right.charAt(0);if(utils.cursor.selection()===!1){for(i=0;i<charSettings.keyMap.length;i++)if(charSettings.keyMap[i].open==leftChar&&charSettings.keyMap[i].close==rightChar){var edited=val.substring(0,pos-1)+val.substring(pos+1);return utils.editor.set(edited),utils.cursor.set(pos-1),void 0}var edited=val.substring(0,pos-1)+val.substring(pos);utils.editor.set(edited),utils.cursor.set(pos-1)}else{var sel=utils.cursor.selection(),edited=val.substring(0,sel.start)+val.substring(sel.end);utils.editor.set(edited),utils.cursor.set(pos)}utils._callHook("delete:after")}}},charFuncs={openedChar:function(_char,e){utils.preventDefaultEvent(e),utils._callHook("openChar:before");var pos=utils.cursor.get(),val=utils.editor.get(),left=val.substring(0,pos),right=val.substring(pos),edited=left+_char.open+_char.close+right;defaults.textarea.value=edited,utils.cursor.set(pos+1),utils._callHook("openChar:after")},closedChar:function(_char,e){var pos=utils.cursor.get(),val=utils.editor.get(),toOverwrite=val.substring(pos,pos+1);return toOverwrite==_char.close?(utils.preventDefaultEvent(e),utils._callHook("closeChar:before"),utils.cursor.set(utils.cursor.get()+1),utils._callHook("closeChar:after"),!0):!1}},action={filter:function(e){if(utils.fenceRange()){var theCode=e.which||e.keyCode;if(39!=theCode&&(40!=theCode||0!==e.which)){var i,_char=String.fromCharCode(theCode);for(i=0;i<charSettings.keyMap.length;i++)if(charSettings.keyMap[i].close==_char){var didClose=defaults.overwrite&&charFuncs.closedChar(charSettings.keyMap[i],e);!didClose&&charSettings.keyMap[i].open==_char&&defaults.autoOpen&&charFuncs.openedChar(charSettings.keyMap[i],e)}else charSettings.keyMap[i].open==_char&&defaults.autoOpen&&charFuncs.openedChar(charSettings.keyMap[i],e)}}},listen:function(){defaults.replaceTab&&utils.addEvent(defaults.textarea,"keydown",intercept.tabKey),defaults.autoIndent&&utils.addEvent(defaults.textarea,"keydown",intercept.enterKey),defaults.autoStrip&&utils.addEvent(defaults.textarea,"keydown",intercept.deleteKey),utils.addEvent(defaults.textarea,"keypress",action.filter),utils.addEvent(defaults.textarea,"keydown",function(){utils._callHook("keydown")}),utils.addEvent(defaults.textarea,"keyup",function(){utils._callHook("keyup")})}},init=function(opts){opts.textarea&&(utils._callHook("init:before",!1),utils.deepExtend(defaults,opts),utils.defineNewLine(),defaults.softTabs?tab=" ".repeat(defaults.tabSize):(tab="	",utils.defineTabSize(defaults.tabSize)),action.listen(),utils._callHook("init:after",!1))};this.destroy=function(){utils.removeEvent(defaults.textarea,"keydown",intercept.tabKey),utils.removeEvent(defaults.textarea,"keydown",intercept.enterKey),utils.removeEvent(defaults.textarea,"keydown",intercept.deleteKey),utils.removeEvent(defaults.textarea,"keypress",action.filter)},init(userOpts)};"undefined"!=typeof module&&module.exports&&(module.exports=Behave),"undefined"==typeof ender&&(this.Behave=Behave,this.BehaveHooks=BehaveHooks),"function"==typeof define&&define.amd&&define("behave",[],function(){return Behave})}).call(this);